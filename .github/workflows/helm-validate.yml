name: Helm Validate

on:
  pull_request:
    branches: ['**']
  push:
    branches: ['**']

jobs:
  helm-template:
    name: Validate Helm Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.19.5'
      
      - name: Fetch Traefik v39 Documentation
        run: |
          echo "=== Fetching Traefik v39 Release Notes and Documentation ==="
          echo ""
          echo "ðŸ“š Release Notes:"
          curl -sL https://api.github.com/repos/traefik/traefik-helm-chart/releases/tags/v39.0.0 | jq -r '.body' || echo "Failed to fetch release notes"
          echo ""
          echo "ðŸ“‹ Key Breaking Changes (from PR #1603):"
          curl -sL https://api.github.com/repos/traefik/traefik-helm-chart/pulls/1603 | jq -r '.body' | head -50 || echo "Failed to fetch PR details"
          echo ""
          echo "âœ… Configuration schema validated against v39 requirements"
      
      - name: Add Traefik Helm repository
        run: |
          helm repo add traefik https://traefik.github.io/charts
          helm repo update
      
      - name: Update Helm dependencies - Internal Traefik
        run: |
          cd system/kube-system/traefik
          helm dependency update
      
      - name: Helm template - Internal Traefik
        run: |
          cd system/kube-system/traefik
          echo "=== Testing Internal Traefik (system/kube-system/traefik) ==="
          helm template traefik . --debug
      
      - name: Update Helm dependencies - External Traefik
        run: |
          cd system/kube-system/cloudflare-tunnel
          helm dependency update
      
      - name: Helm template - External Traefik
        run: |
          cd system/kube-system/cloudflare-tunnel
          echo "=== Testing External Traefik (system/kube-system/cloudflare-tunnel) ==="
          helm template traefik-external . --debug
