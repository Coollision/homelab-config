name: Validate Charts and YAML

on:
  pull_request:
    branches: ['**']
  push:
    branches: ['**']

jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install yamllint
        run: pip install yamllint
      
      - name: Run yamllint
        run: |
          echo "=== Validating YAML syntax and formatting ==="
          yamllint --version
          # Run yamllint with custom config for ArgoCD compatibility
          # Warnings only - non-blocking
          yamllint -c .yamllint.yml . || echo "âš ï¸  YAML linting found issues (non-blocking)"
          echo "âœ… YAML validation complete"
  
  helm-validate:
    name: Helm Charts Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.19.5'
      
      - name: Add Helm repositories
        run: |
          echo "=== Adding common Helm repositories ==="
          helm repo add traefik https://traefik.github.io/charts
          helm repo add jetstack https://charts.jetstack.io
          helm repo add metallb https://metallb.github.io/metallb
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          echo "âœ… Repositories added"
      
      - name: Find and validate all Helm charts
        run: |
          echo "=== Discovering Helm charts in repository ==="
          CHART_DIRS=$(find . -name "Chart.yaml" -type f -not -path "*/charts/*" -not -path "*/.git/*" -exec dirname {} \;)
          CHART_COUNT=$(echo "$CHART_DIRS" | wc -l)
          echo "Found $CHART_COUNT Helm charts to validate"
          echo ""
          
          FAILED_CHARTS=()
          SUCCESS_COUNT=0
          
          for chart_dir in $CHART_DIRS; do
            chart_name=$(basename "$chart_dir")
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Validating: $chart_dir"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Check if chart has dependencies
            if [ -f "$chart_dir/Chart.yaml" ]; then
              if grep -q "dependencies:" "$chart_dir/Chart.yaml"; then
                echo "ğŸ“¥ Updating dependencies..."
                (cd "$chart_dir" && helm dependency update) || {
                  echo "âš ï¸  Warning: Failed to update dependencies for $chart_dir"
                }
              fi
            fi
            
            # Run helm lint
            echo "ğŸ” Running helm lint..."
            if helm lint "$chart_dir"; then
              echo "âœ… Lint passed for $chart_dir"
            else
              echo "âŒ Lint failed for $chart_dir"
              FAILED_CHARTS+=("$chart_dir (lint)")
            fi
            
            # Run helm template to validate rendering
            echo "ğŸ”§ Running helm template..."
            if helm template "$chart_name" "$chart_dir" > /dev/null 2>&1; then
              echo "âœ… Template rendering passed for $chart_dir"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âŒ Template rendering failed for $chart_dir"
              echo "Attempting with --debug for more details..."
              helm template "$chart_name" "$chart_dir" --debug || true
              FAILED_CHARTS+=("$chart_dir (template)")
            fi
            
            echo ""
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Validation Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total charts: $CHART_COUNT"
          echo "Successful: $SUCCESS_COUNT"
          echo "Failed: ${#FAILED_CHARTS[@]}"
          
          if [ ${#FAILED_CHARTS[@]} -gt 0 ]; then
            echo ""
            echo "âŒ Failed charts:"
            printf '%s\n' "${FAILED_CHARTS[@]}"
            echo ""
            echo "âš ï¸  Some charts failed validation. Please review the errors above."
            exit 1
          else
            echo ""
            echo "âœ… All Helm charts validated successfully!"
          fi
