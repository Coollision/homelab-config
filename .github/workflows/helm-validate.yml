name: Validate Charts and YAML

on:
  pull_request:
    branches: ['**']
  push:
    branches: ['**']

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect Changed Charts
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.detect.outputs.charts }}
      chart-count: ${{ steps.detect.outputs.chart-count }}
      yaml-changed: ${{ steps.detect.outputs.yaml-changed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for accurate diff
      
      - name: Detect changed charts and YAML files
        id: detect
        run: |
          # Determine the base ref for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            # For push events, compare with previous commit
            BASE_REF="${{ github.event.before }}"
            # If it's the first commit or base ref is all zeros, compare with HEAD~1
            if [ "$BASE_REF" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE_REF" ]; then
              BASE_REF="HEAD~1"
            fi
          fi
          
          echo "Comparing against base: $BASE_REF"
          
          # Get all changed files
          CHANGED_FILES=$(git diff --name-only "$BASE_REF" HEAD 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected, will validate all charts"
            CHANGED_FILES=$(find . -name "Chart.yaml" -o -name "values.yaml" -o -name "*.yml" -o -name "*.yaml" | sed 's|^\./||')
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Find all chart directories that have changes
          CHANGED_CHART_DIRS=""
          
          # Check for any YAML changes for yaml-lint job
          YAML_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -qE '\.(yaml|yml)$'; then
            YAML_CHANGED="true"
          fi
          
          # Find charts with changes
          while IFS= read -r changed_file; do
            [ -z "$changed_file" ] && continue
            
            # Check if this file belongs to a chart directory
            file_dir=$(dirname "$changed_file")
            
            # Walk up the directory tree to find Chart.yaml
            current_dir="$file_dir"
            while [ "$current_dir" != "." ] && [ "$current_dir" != "/" ]; do
              if [ -f "$current_dir/Chart.yaml" ]; then
                # Exclude charts in the charts/ subdirectory (dependencies)
                if ! echo "$current_dir" | grep -q "/charts/"; then
                  CHANGED_CHART_DIRS="$CHANGED_CHART_DIRS$current_dir"$'\n'
                fi
                break
              fi
              current_dir=$(dirname "$current_dir")
            done
            
            # Also check if the changed file itself is Chart.yaml
            if [ "$(basename "$changed_file")" = "Chart.yaml" ] && [ -f "$changed_file" ]; then
              chart_dir=$(dirname "$changed_file")
              if ! echo "$chart_dir" | grep -q "/charts/"; then
                CHANGED_CHART_DIRS="$CHANGED_CHART_DIRS$chart_dir"$'\n'
              fi
            fi
          done <<< "$CHANGED_FILES"
          
          # Remove duplicates and empty lines
          CHANGED_CHART_DIRS=$(echo "$CHANGED_CHART_DIRS" | sort -u | grep -v '^$' || true)
          
          if [ -z "$CHANGED_CHART_DIRS" ]; then
            echo "No chart changes detected"
            echo "charts=[]" >> $GITHUB_OUTPUT
            echo "chart-count=0" >> $GITHUB_OUTPUT
            echo "yaml-changed=$YAML_CHANGED" >> $GITHUB_OUTPUT
          else
            echo "Changed charts detected:"
            echo "$CHANGED_CHART_DIRS"
            
            # Convert to JSON array
            CHARTS_JSON="["
            FIRST=true
            while IFS= read -r chart_dir; do
              [ -z "$chart_dir" ] && continue
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                CHARTS_JSON="$CHARTS_JSON,"
              fi
              CHARTS_JSON="$CHARTS_JSON\"$chart_dir\""
            done <<< "$CHANGED_CHART_DIRS"
            CHARTS_JSON="$CHARTS_JSON]"
            
            CHART_COUNT=$(echo "$CHANGED_CHART_DIRS" | wc -l)
            
            echo "charts=$CHARTS_JSON" >> $GITHUB_OUTPUT
            echo "chart-count=$CHART_COUNT" >> $GITHUB_OUTPUT
            echo "yaml-changed=$YAML_CHANGED" >> $GITHUB_OUTPUT
            
            echo ""
            echo "Will validate $CHART_COUNT chart(s)"
          fi

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.yaml-changed == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-yamllint-${{ hashFiles('.github/workflows/helm-validate.yml') }}
          restore-keys: |
            ${{ runner.os }}-pip-yamllint-
      
      - name: Install yamllint
        run: pip install yamllint
      
      - name: Run yamllint
        run: |
          echo "=== Validating YAML syntax and formatting ==="
          yamllint --version
          # Run yamllint with custom config for ArgoCD compatibility
          set +e
          yamllint -c .yamllint.yml . 
          YAMLLINT_EXIT=$?
          set -e
          
          if [ $YAMLLINT_EXIT -ne 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  YAML linting found issues (warnings only - non-blocking)"
          fi
          echo "‚úÖ YAML validation complete"
  
  helm-validate:
    name: Validate Charts
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.chart-count != '0'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.19.5'
      
      - name: Cache Helm repositories
        uses: actions/cache@v4
        with:
          path: ~/.cache/helm/repository
          key: ${{ runner.os }}-helm-repo-${{ hashFiles('**/Chart.yaml') }}
          restore-keys: |
            ${{ runner.os }}-helm-repo-
      
      - name: Cache Helm charts
        uses: actions/cache@v4
        with:
          path: |
            **/charts/*.tgz
            **/Chart.lock
          key: ${{ runner.os }}-helm-charts-${{ hashFiles('**/Chart.yaml', '**/Chart.lock') }}
          restore-keys: |
            ${{ runner.os }}-helm-charts-
      
      - name: Auto-discover and add Helm repositories
        run: |
          echo "=== Auto-discovering Helm repositories from changed charts ==="
          
          CHARTS='${{ needs.detect-changes.outputs.charts }}'
          
          # Extract repository URLs only from changed charts
          REPO_URLS=""
          for chart_dir in $(echo "$CHARTS" | jq -r '.[]'); do
            if [ -f "$chart_dir/Chart.yaml" ]; then
              chart_repos=$(grep -h "repository:" "$chart_dir/Chart.yaml" | \
                grep -E "https?://" | \
                sed 's/.*repository: *//g' | \
                sed 's/ *#.*//g' || true)
              if [ -n "$chart_repos" ]; then
                REPO_URLS="$REPO_URLS"$'\n'"$chart_repos"
              fi
            fi
          done
          
          # Get unique repositories
          REPO_URLS=$(echo "$REPO_URLS" | sort -u | grep -v '^$' || true)
          
          if [ -z "$REPO_URLS" ]; then
            echo "No external Helm repositories needed for changed charts"
          else
            echo "Found repositories to add:"
            echo "$REPO_URLS"
            echo ""
            
            # Add each repository with a generated name
            REPO_COUNT=0
            while IFS= read -r repo_url; do
              [ -z "$repo_url" ] && continue
              
              # Generate a simple name from the URL
              repo_name=$(echo "$repo_url" | sed 's|https://||g' | sed 's|http://||g' | sed 's|/|-|g' | sed 's|\.|-|g')
              
              echo "Adding repository: $repo_name ($repo_url)"
              if helm repo add "$repo_name" "$repo_url" 2>&1; then
                REPO_COUNT=$((REPO_COUNT + 1))
              else
                echo "‚ö†Ô∏è  Warning: Failed to add repository $repo_url"
              fi
            done <<< "$REPO_URLS"
            
            echo ""
            echo "Updating repository indexes..."
            if [ "$REPO_COUNT" -gt 0 ]; then
              helm repo update
            else
              echo "‚ö†Ô∏è  No repositories were successfully added, skipping update"
            fi
            echo ""
            echo "‚úÖ Successfully added $REPO_COUNT Helm repositories"
          fi
      
      - name: Validate changed Helm charts
        run: |
          echo "=== Validating changed Helm charts ==="
          
          CHARTS='${{ needs.detect-changes.outputs.charts }}'
          CHART_DIRS=$(echo "$CHARTS" | jq -r '.[]' | sort)
          
          if [ -z "$CHART_DIRS" ]; then
            echo "No Helm charts to validate"
            exit 0
          fi
          
          CHART_COUNT=${{ needs.detect-changes.outputs.chart-count }}
          echo "Validating $CHART_COUNT changed chart(s)"
          echo ""
          
          FAILED_CHARTS=()
          SUCCESS_COUNT=0
          
          while IFS= read -r chart_dir; do
            [ -z "$chart_dir" ] && continue
            
            chart_name=$(basename "$chart_dir")
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ Validating: $chart_dir"
            
            # Check if this is a library chart
            IS_LIBRARY=false
            if [ -f "$chart_dir/Chart.yaml" ]; then
              if grep -qE "^[[:space:]]*type:[[:space:]]*library" "$chart_dir/Chart.yaml"; then
                IS_LIBRARY=true
                echo "   (Library chart - will skip template rendering)"
              fi
            fi
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            CHART_FAILED=false
            
            # Check if chart has dependencies
            if [ -f "$chart_dir/Chart.yaml" ]; then
              if grep -q "dependencies:" "$chart_dir/Chart.yaml"; then
                echo "üì• Updating dependencies..."
                if ! (cd "$chart_dir" && helm dependency update 2>&1); then
                  echo "‚ùå Failed to update dependencies for $chart_dir"
                  FAILED_CHARTS+=("$chart_dir (dependency update failed)")
                  CHART_FAILED=true
                fi
              fi
            fi
            
            # Run helm lint
            echo "üîç Running helm lint..."
            if helm lint "$chart_dir" 2>&1; then
              echo "‚úÖ Lint passed for $chart_dir"
            else
              echo "‚ùå Lint failed for $chart_dir"
              FAILED_CHARTS+=("$chart_dir (lint failed)")
              CHART_FAILED=true
            fi
            
            # Run helm template to validate rendering (skip for library charts)
            if [ "$IS_LIBRARY" = false ]; then
              echo "üîß Running helm template..."
              TEMPLATE_OUTPUT=$(helm template "$chart_name" "$chart_dir" 2>&1)
              if [ $? -eq 0 ]; then
                echo "‚úÖ Template rendering passed for $chart_dir"
              else
                echo "‚ùå Template rendering failed for $chart_dir"
                echo "Error output:"
                echo "$TEMPLATE_OUTPUT"
                FAILED_CHARTS+=("$chart_dir (template failed)")
                CHART_FAILED=true
              fi
            else
              echo "‚è≠Ô∏è  Skipping template rendering (library chart)"
            fi
            
            # Count successful charts (passed all validations)
            if [ "$CHART_FAILED" = false ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
            
            echo ""
          done <<< "$CHART_DIRS"
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Validation Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Total charts: $CHART_COUNT"
          echo "Successful: $SUCCESS_COUNT"
          echo "Failed: $((CHART_COUNT - SUCCESS_COUNT))"
          
          if [ ${#FAILED_CHARTS[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå Failed validations:"
            printf '%s\n' "${FAILED_CHARTS[@]}"
            echo ""
            echo "‚ö†Ô∏è  Some charts failed validation. Please review the errors above."
            exit 1
          else
            echo ""
            echo "‚úÖ All changed Helm charts validated successfully!"
          fi
